<!DOCTYPE html>

<html>
<body>

<p>This example demonstrates how to assign an "onclick" event to a p element.</p>

<button id="counts">get counts</button>
<button id="disconnect">disconnect</button>

<script>
class NISTET {

constructor() {
  this.device = null;
  this.onDisconnected = this.onDisconnected.bind(this);
}

request() {
  let options = {
    "filters": [{
      "namePrefix": "NIST",
      "services": ["7b183224-9168-443e-a927-7aeea07e8105"]
    }]
  };
  return navigator.bluetooth.requestDevice(options)
  .then(device => {
    this.device = device;
    this.device.addEventListener('gattserverdisconnected', this.onDisconnected);
  });
}

connect() {
  if (!this.device) {
    return Promise.reject('Device is not connected.');
  }
  return this.device.gatt.connect();
}

readCounts() {
  return this.device.gatt.getPrimaryService("7b183224-9168-443e-a927-7aeea07e8105")
  .then(service => service.getCharacteristic("292bd3d2-14ff-45ed-9343-55d125edb721"))
  .then(characteristic => characteristic.readValue());
}

disconnect() {
  if (!this.device) {
    return Promise.reject('Device is not connected.');
  }
  return this.device.gatt.disconnect();
}

onDisconnected() {
  console.log('Device is disconnected.');
}
}

var nISTET = new NISTET();

document.querySelector('#counts').addEventListener('click', event => {
nISTET.request()
.then(_ => nISTET.connect())
.then(_ => { 
    console.log("hello"); 
    console.log(nISTET.readCounts())
    /* Do something with nISTET... */})
.catch(error => { console.log(error) });
});
document.querySelector('#disconnect').addEventListener('click', event => {
nISTET.disconnect();
});
</script>

</body>
</html>